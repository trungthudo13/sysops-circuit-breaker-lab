apiVersion: networking.istio.io/v1alpha3
kind: EnvoyFilter
metadata:
  name: cb-fallback-direct-response
  namespace: circuit-breaker
spec:
  workloadSelector:
    labels:
      app: frontier        # áp vào sidecar của caller
  configPatches:
  # - applyTo: VIRTUAL_HOST
  #   match:
  #     context: GATEWAY
  #     routeConfiguration:
  #       vhost:
  #         domainName: 'backline.circuit-breaker.svc.cluster.local'
  - applyTo: NETWORK_FILTER
    match:
      context: SIDECAR_OUTBOUND
      listener:
        filterChain:
          filter:
            name: envoy.filters.network.http_connection_manager
    patch:
      operation: MERGE
      value:
        name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          local_reply_config:
            mappers:
            # 502 từ app/frontier hoặc upstream gateway
            - filter:
                status_code_filter:
                  comparison: { op: GE, value: { default_value: 500 } }
              status_code: 301
              body: { inline_string: '{"ok":false,"source":"mesh-fallback","reason":"bad_gateway"}' }
              headers_to_add:
              - header: { key: content-type, value: application/json }
            # # 503: no healthy upstream, upstream reset…
            # - filter:
            #     status_code_filter:
            #       comparison: { op: EQ, value: { default_value: 503 } }
            #   status_code: 200
            #   body: { inline_string: '{"ok":false,"source":"mesh-fallback","reason":"unavailable"}' }
            #   headers_to_add:
            #   - header: { key: content-type, value: application/json }
            # # 504: timeout / per-try-timeout
            # - filter:
            #     status_code_filter:
            #       comparison: { op: EQ, value: { default_value: 504 } }
            #   status_code: 200
            #   body: { inline_string: '{"ok":false,"source":"mesh-fallback","reason":"timeout"}' }
            #   headers_to_add:
            #   - header: { key: content-type, value: application/json }